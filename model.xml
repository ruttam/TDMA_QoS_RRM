<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>// Place global declarations here.

// In this model time is measured in ms,
// it can be further atomized changing the
// unit value, e.g. to 10, 100
int unit = 1000;    // time unit ratio wrt 1 ms

int frame_size = 2 * unit;    // frame size (ms * unit)

clock frame_clk;    // frame clock timer

int broadcast_channel = 0;    // broadcast channel frequency (?)

int number_BS = 2;    // number of Base Stations
typedef int [0, number_BS - 1] BSid_t;

int number_UE = 10;    // number of User Equipment
typedef int [0, number_UE - 1] UEid_t;

int number_profiles = 4;
typedef int [0, number_profiles - 1] profileId_t;

profileId_t profile[UEid_t] = {0, 1, 2, 3, 1, 2, 0, 1, 2, 3};

profileId_t RTa = 0;           // Real-Time Audio
profileId_t HqRTa = 1;         // High-Quality Real-Time Audio
profileId_t sRTa = 2;          // Sporadic Real-Time Audio
profileId_t Listen_Only = 3;   // Listen-Only

// --------------------------------------------------------------------------------------------
// INIT
// --------------------------------------------------------------------------------------------

broadcast chan started[UEid_t];    // UE start signal

int offsets[2][UEid_t] = 
{
    {1, 2, 3, 4, 5, 6, 7, 8, 9, 10},
    {10, 20, 5, 0, 10, 40, 7, 15, 30, 0}
};

int start_offset[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // offset of UE start signal

void setOffset(int offset_id)    // setting offset values from possible variations in offsets
{
    for(i: UEid_t) start_offset[i] = offsets[offset_id][i] * unit;
}

// --------------------------------------------------------------------------------------------
// CONNECT
// --------------------------------------------------------------------------------------------

int connection_channel_stability[UEid_t][2] = 
{
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75}
};

broadcast chan connected[UEid_t];    // UE connected signal

broadcast chan disconnected[UEid_t];    // UE disconnected signal

broadcast chan failed[UEid_t];    // UE signal for failed latency requirements 

int disconnect_timeout = 5000 * unit;    // Timeout for disconnect in ms

// --------------------------------------------------------------------------------------------
// LISTEN_ONLY
// --------------------------------------------------------------------------------------------

broadcast chan BCH;    // broadcast channel

broadcast chan sleep[UEid_t];    // UE signal for RF module to sleep

broadcast chan wake_up[UEid_t];    // UE signal for RF module to wake-up

chan UCCH[UEid_t];    // Up-Link control channel

int channel_interference_probability[UEid_t][2] = 
{
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75},
    {25, 75}
};

bool UL_ACK[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // BS acknowledge of UL transmissions from the UE

int sleep_time[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // RRM (Radio Resource Manager) calculated sleep time for UE after receiving UL ACKs

// --------------------------------------------------------------------------------------------
// STREAM
// --------------------------------------------------------------------------------------------

broadcast chan stream[UEid_t];    // UE signal to start audio streaming

broadcast chan sample[UEid_t];    // UE signal to DSP to start audio sampling

broadcast chan stop_sample[UEid_t];    // UE signal to DSP to stop audio sampling (in case of mode changes)

broadcast chan sample_ready[UEid_t];    // UE signal from DSP that a new audio sample is ready loaded in the memory

int samples_ready[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // audio samples ready to be read from memory

int slot_start[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // start times of dedicated TCH slots for the nodes in current frame

int slot_size[UEid_t] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};    // sizes of dedicated TCH slots for the nodes in current frame (ms * unit)




</declaration>
	<template>
		<name>Scheduler</name>
		<location id="id0" x="0" y="0">
		</location>
		<init ref="id0"/>
	</template>
	<template>
		<name>BaseStation</name>
		<location id="id1" x="0" y="0">
		</location>
		<init ref="id1"/>
	</template>
	<template>
		<name>UserStates</name>
		<parameter>int id</parameter>
		<declaration>clock offset;    // timer for start offset</declaration>
		<location id="id2" x="-15130" y="-15181">
			<name x="-15140" y="-15215">INIT</name>
		</location>
		<location id="id3" x="-15130" y="-14942">
			<name x="-15240" y="-14943">LISTEN_ONLY</name>
			<urgent/>
		</location>
		<location id="id4" x="-14832" y="-14942">
			<name x="-14815" y="-14951">STREAMING</name>
			<urgent/>
		</location>
		<location id="id5" x="-14985" y="-15028">
			<name x="-15011" y="-15062">FAILED</name>
			<urgent/>
		</location>
		<location id="id6" x="-14985" y="-14815">
			<name x="-15019" y="-14849">SLEEPING</name>
			<urgent/>
		</location>
		<location id="id7" x="-14832" y="-15181">
			<name x="-14815" y="-15190">DISCONNECTED</name>
			<urgent/>
		</location>
		<location id="id8" x="-15130" y="-15070">
			<name x="-15113" y="-15079">CONNECTING</name>
			<urgent/>
		</location>
		<init ref="id2"/>
		<transition>
			<source ref="id8"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-15249" y="-15147">disconnected[id]?</label>
			<label kind="assignment" x="-15249" y="-15130">offset = 0</label>
			<nail x="-15257" y="-15096"/>
			<nail x="-15257" y="-15155"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-15232" y="-15028">connected[id]?</label>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id3"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-15266" y="-15249">disconnected[id]?</label>
			<nail x="-15266" y="-14960"/>
			<nail x="-15266" y="-15223"/>
			<nail x="-14832" y="-15223"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id2"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-14832" y="-15078">disconnected[id]?</label>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-14943" y="-14866">wake_up[id]?</label>
			<nail x="-14858" y="-14849"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-15096" y="-14866">wake_up[id]?</label>
			<nail x="-15104" y="-14849"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="-14900" y="-14832">sleep[id]?</label>
			<nail x="-14832" y="-14815"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="-15112" y="-14832">sleep[id]?</label>
			<nail x="-15130" y="-14815"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-15087" y="-15045">failed[id]?</label>
			<nail x="-15104" y="-15028"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-14926" y="-15045">failed[id]?</label>
			<nail x="-14858" y="-15028"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-15036" y="-14909">stop_sample[id]?</label>
			<nail x="-14909" y="-14891"/>
			<nail x="-15070" y="-14891"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-15028" y="-14960">stream[id]?</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id8"/>
			<label kind="guard" x="-15121" y="-15147">offset &gt; start_offset[id]</label>
			<label kind="synchronisation" x="-15121" y="-15130">started[id]!</label>
		</transition>
	</template>
	<template>
		<name>UserListenOnly</name>
		<parameter>int id</parameter>
		<declaration>clock x;    // timer for latency

clock y;    // timer for sleep

clock z;    // timer for disconnect

bool dedicated_channel_set = false;    // 0 - false, 1 - true

int latency;    // passable latency for UCCH control commands (DLC/MAC)

int prob_failure = channel_interference_probability[id][0];

int prob_success = channel_interference_probability[id][1];</declaration>
		<location id="id9" x="-1368" y="-654">
			<name x="-1393" y="-636">INITIAL</name>
		</location>
		<location id="id10" x="-731" y="-654">
			<name x="-850" y="-646">BCH_RECEIVED</name>
			<urgent/>
		</location>
		<location id="id11" x="-731" y="-884">
			<name x="-765" y="-918">META_DATA</name>
			<urgent/>
		</location>
		<location id="id12" x="-1071" y="-561">
			<name x="-1088" y="-544">DL_NACK</name>
			<urgent/>
		</location>
		<location id="id13" x="-1199" y="-655">
			<name x="-1283" y="-697">WAIT_BCH</name>
			<label kind="invariant" x="-1283" y="-680">x &lt;= latency</label>
		</location>
		<location id="id14" x="-1198" y="-561">
			<name x="-1215" y="-544">FAIL</name>
			<urgent/>
		</location>
		<location id="id15" x="-1199" y="-892">
			<name x="-1250" y="-926">DSICONNECT</name>
			<urgent/>
		</location>
		<location id="id16" x="-986" y="-884">
			<name x="-996" y="-918">TRANSMIT</name>
			<urgent/>
		</location>
		<location id="id17" x="-544" y="-654">
			<name x="-561" y="-688">UL_ACK</name>
			<urgent/>
		</location>
		<location id="id18" x="-731" y="-773">
			<name x="-816" y="-782">UL_NACK</name>
			<urgent/>
		</location>
		<location id="id19" x="-544" y="-561">
			<name x="-527" y="-569">SLEEP</name>
			<label kind="invariant" x="-527" y="-553">y &lt;= sleep_time[id]</label>
			<urgent/>
		</location>
		<location id="id20" x="-459" y="-774">
			<name x="-442" y="-782">STREAM</name>
			<urgent/>
		</location>
		<branchpoint id="id21" x="-986" y="-825">
		</branchpoint>
		<init ref="id9"/>
		<transition>
			<source ref="id20"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="-578" y="-926">disconnected[id]?</label>
			<label kind="assignment" x="-1445" y="-926">z = 0,
z'= 0,
x = 0,
x' = 0</label>
			<nail x="-459" y="-926"/>
			<nail x="-1401" y="-925"/>
			<nail x="-1401" y="-653"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id20"/>
			<label kind="guard" x="-705" y="-833">dedicated_channel_set == 1 &amp;&amp;
profile[id] == RTa ||
profile[id] == HqRTa</label>
			<label kind="synchronisation" x="-705" y="-774">stream[id]!</label>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id13"/>
			<label kind="probability" x="-1096" y="-850">prob_failure</label>
			<nail x="-1113" y="-825"/>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-977" y="-782">UCCH[id]!</label>
			<label kind="assignment" x="-977" y="-748">dedicated_channel_set = 1</label>
			<label kind="probability" x="-977" y="-765">prob_success</label>
			<nail x="-986" y="-714"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id21"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id9"/>
			<label kind="assignment" x="-1360" y="-892">z = 0,
z'= 0,
x = 0,
x' = 0</label>
			<nail x="-1367" y="-891"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-1335" y="-655">connected[id]?</label>
			<label kind="assignment" x="-1334" y="-637">x = 0,
y' = 0,
z' = 0</label>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id13"/>
			<label kind="guard" x="-688" y="-586">y &gt;= sleep_time[id]</label>
			<label kind="assignment" x="-603" y="-561">y = 0,
y' = 0</label>
			<nail x="-850" y="-561"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id19"/>
			<label kind="assignment" x="-535" y="-646">y = 0,
y' = 1</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id18"/>
			<label kind="guard" x="-722" y="-722">UL_ACK[id] == 0</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id17"/>
			<label kind="guard" x="-688" y="-680">UL_ACK[id] == 1</label>
			<label kind="assignment" x="-688" y="-654">x = 0</label>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id16"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id13"/>
			<nail x="-1071" y="-603"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id10"/>
			<label kind="synchronisation" x="-977" y="-672">BCH?</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id12"/>
			<label kind="assignment" x="-1147" y="-561">z = x,
z' = 1</label>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id14"/>
			<label kind="guard" x="-1190" y="-612">x &gt; latency</label>
			<label kind="synchronisation" x="-1190" y="-595">failed[id]!</label>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id15"/>
			<label kind="guard" x="-1351" y="-765">z &gt; disconnect_timeout</label>
			<label kind="synchronisation" x="-1317" y="-782">disconnected[id]!</label>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id11"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">User</name>
		<parameter>int id, int uart_speed, int qca_latency</parameter>
		<declaration>// Place local declarations here.

clock x;

int i = 20;    // overall channel count
int j;

int MCS;    // MCS assigned for this PP transmissions

int transmission_latency = 0;

int channel_stability_latency = 0;
bool channel_stable(){
    return 0;
}

double dsp_to_qca_latency = 0.0;    // DSP to QCA UART transmission
double dsp_to_qca(){
    return (frame_size/1000 * audio_data_rate)/uart_speed;
}</declaration>
		<location id="id22" x="-1113" y="-578">
			<name x="-1181" y="-629">PROCESS_CODEC</name>
			<label kind="invariant" x="-1173" y="-612">x &lt;= codec_latency</label>
		</location>
		<location id="id23" x="-926" y="-578">
			<name x="-977" y="-612">LOAD_TO_MEM</name>
		</location>
		<location id="id24" x="-1359" y="-578">
			<name x="-1385" y="-629">SAMPLE</name>
			<label kind="invariant" x="-1402" y="-612">x &lt;= time_per_sample</label>
		</location>
		<location id="id25" x="-1360" y="-485">
			<name x="-1411" y="-476">PROCESS_QCA</name>
			<label kind="invariant" x="-1411" y="-459">x &lt;= qca_latency</label>
		</location>
		<location id="id26" x="-1113" y="-485">
			<name x="-1147" y="-476">DSP_to_QCA</name>
			<label kind="invariant" x="-1173" y="-459">x &lt;= dsp_to_qca_latency</label>
		</location>
		<location id="id27" x="-1564" y="-578">
			<name x="-1590" y="-612">INITIAL</name>
		</location>
		<init ref="id27"/>
		<transition>
			<source ref="id22"/>
			<target ref="id23"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id27"/>
			<nail x="-1394" y="-510"/>
			<nail x="-1521" y="-510"/>
		</transition>
		<transition>
			<source ref="id25"/>
			<target ref="id24"/>
			<label kind="assignment" x="-1351" y="-544">x = 0</label>
			<nail x="-1360" y="-519"/>
		</transition>
		<transition>
			<source ref="id27"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="-1504" y="-604">sample[id]?</label>
			<label kind="assignment" x="-1530" y="-578">x = 0</label>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id25"/>
			<label kind="assignment" x="-1292" y="-502">x = 0</label>
		</transition>
		<transition>
			<source ref="id22"/>
			<target ref="id26"/>
			<label kind="assignment" x="-1105" y="-544">x = 0</label>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id22"/>
			<label kind="assignment" x="-1258" y="-578">x = 0</label>
		</transition>
	</template>
	<template>
		<name>UserConnect</name>
		<parameter>int id</parameter>
		<declaration>int i = 0;    // channel scan counter

int j = 0;    // re-try scan counter

int number_channels = 10;    // number of hard-coded channels to scan through

int channels[number_channels] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9};    // channel frequencies to scan for BS down-link reception

int channel_stability_latency = 0;    // time to test channel stability before connecting to the BS as LISTEN_ONLY UE

clock x;

int prob_stable = connection_channel_stability[id][1];

int prob_unstable = connection_channel_stability[id][0];

int number_retries = 10;    // number of allowed retries of channel scanning before going to the INITIAL state</declaration>
		<location id="id28" x="-2856" y="-3111">
			<name x="-2866" y="-3145">INITIAL</name>
		</location>
		<location id="id29" x="-2856" y="-2813">
			<name x="-2839" y="-2830">TESTING_CHANNEL</name>
			<label kind="invariant" x="-2839" y="-2813">x &lt;= channel_stability_latency</label>
		</location>
		<location id="id30" x="-2856" y="-2983">
			<name x="-2847" y="-3009">SCANNING</name>
			<urgent/>
		</location>
		<location id="id31" x="-2711" y="-2652">
			<name x="-2745" y="-2685">CONNECTED</name>
			<urgent/>
		</location>
		<branchpoint id="id32" x="-2856" y="-2652">
		</branchpoint>
		<init ref="id28"/>
		<transition>
			<source ref="id31"/>
			<target ref="id28"/>
			<nail x="-2575" y="-2652"/>
			<nail x="-2575" y="-3113"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id30"/>
			<label kind="guard" x="-2745" y="-2983">i &gt; number_channels &amp;&amp;
j &lt; number_retries</label>
			<label kind="assignment" x="-2745" y="-2949">i = 0,
j++</label>
			<nail x="-2754" y="-2983"/>
			<nail x="-2754" y="-2907"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id28"/>
			<label kind="guard" x="-3043" y="-3103">j &gt;= number_retries</label>
			<label kind="synchronisation" x="-3043" y="-3120">disconnected[id]!</label>
			<label kind="assignment" x="-3043" y="-3085">i = 0,
j = 0</label>
			<nail x="-2932" y="-3112"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id30"/>
			<label kind="guard" x="-3111" y="-2983">channels[i] != broadcast_channel</label>
			<label kind="assignment" x="-3111" y="-2966">i++</label>
			<nail x="-3120" y="-2983"/>
			<nail x="-3120" y="-2864"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id29"/>
			<label kind="guard" x="-2847" y="-2898">channels[i] == broadcast_channel</label>
			<label kind="assignment" x="-2847" y="-2881">x = 0,
x' = 1</label>
		</transition>
		<transition>
			<source ref="id32"/>
			<target ref="id30"/>
			<label kind="probability" x="-2966" y="-2669">prob_unstable</label>
			<nail x="-2992" y="-2652"/>
		</transition>
		<transition>
			<source ref="id32"/>
			<target ref="id31"/>
			<label kind="synchronisation" x="-2839" y="-2652">connected[id]!</label>
			<label kind="assignment" x="-2839" y="-2634">i = 0,
j = 0</label>
			<label kind="probability" x="-2839" y="-2669">prob_stable</label>
		</transition>
		<transition>
			<source ref="id29"/>
			<target ref="id32"/>
			<label kind="guard" x="-2847" y="-2762">x &gt; channel_stability_latency</label>
			<label kind="assignment" x="-2847" y="-2745">x = 0,
x' = 0</label>
		</transition>
		<transition>
			<source ref="id28"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-2847" y="-3103">started[id]?</label>
			<label kind="assignment" x="-2847" y="-3086">i = 0,
j = 0,
x' = 0</label>
		</transition>
	</template>
	<template>
		<name>UserStream</name>
		<parameter>int id, int codec_latency, int audio_data_rate, int uart_speed, int qca_latency</parameter>
		<declaration>clock x, y;

int max_lat;    // max latency

int transmission_latency;    // latency of data transmission

int disconnect_timeout;    // time of no DL received before disconnecting (e.g., 5 sec)</declaration>
		<location id="id33" x="-1309" y="-935">
			<name x="-1334" y="-969">INITIAL</name>
		</location>
		<location id="id34" x="-1224" y="-569">
			<name x="-1275" y="-560">TRANSMIT</name>
			<label kind="invariant" x="-1292" y="-543">x &lt;= transmission_latency</label>
		</location>
		<location id="id35" x="-1572" y="-561">
			<name x="-1658" y="-586">WAIT_BCH</name>
		</location>
		<location id="id36" x="-1572" y="-696">
			<name x="-1597" y="-730">FAILED</name>
			<urgent/>
		</location>
		<location id="id37" x="-1504" y="-935">
			<name x="-1615" y="-943">DISCONNECT</name>
			<urgent/>
		</location>
		<location id="id38" x="-1224" y="-620">
			<name x="-1267" y="-654">RETRANSMIT</name>
			<urgent/>
		</location>
		<location id="id39" x="-1165" y="-466">
			<name x="-1284" y="-365">SLEEP</name>
		</location>
		<location id="id40" x="-1156" y="-935">
		</location>
		<location id="id41" x="-994" y="-935">
			<name x="-977" y="-960">LOAD_FROM_MEM</name>
			<label kind="invariant" x="-977" y="-943">x &lt;= dma_latency</label>
		</location>
		<location id="id42" x="-841" y="-1020">
			<name x="-892" y="-1071">WAIT_SAMPLE</name>
			<label kind="invariant" x="-892" y="-1054">y &lt; slot_start[id]</label>
		</location>
		<location id="id43" x="-1156" y="-790">
			<name x="-1173" y="-773">TRANSMIT</name>
			<label kind="invariant" x="-1173" y="-756">x &lt;= transmission_latency</label>
		</location>
		<init ref="id33"/>
		<transition>
			<source ref="id42"/>
			<target ref="id43"/>
			<label kind="guard" x="-960" y="-816">y &gt;= slot_start[id]</label>
			<nail x="-850" y="-790"/>
		</transition>
		<transition>
			<source ref="id40"/>
			<target ref="id43"/>
			<label kind="guard" x="-1147" y="-850">y &gt;= slot_start[id]</label>
		</transition>
		<transition>
			<source ref="id41"/>
			<target ref="id40"/>
			<label kind="guard" x="-1105" y="-901">x &gt; dma_latency</label>
			<nail x="-994" y="-875"/>
			<nail x="-1105" y="-875"/>
		</transition>
		<transition>
			<source ref="id42"/>
			<target ref="id41"/>
			<label kind="synchronisation" x="-994" y="-1003">sample_ready[id]?</label>
			<nail x="-875" y="-977"/>
			<nail x="-994" y="-977"/>
		</transition>
		<transition>
			<source ref="id40"/>
			<target ref="id42"/>
			<label kind="guard" x="-1156" y="-1062">samples_ready[id] == 0 &amp;&amp;
y &lt; slot_start[id]</label>
			<nail x="-1156" y="-1020"/>
		</transition>
		<transition>
			<source ref="id40"/>
			<target ref="id41"/>
			<label kind="guard" x="-1130" y="-960">y &lt; slot_start[id]</label>
			<label kind="assignment" x="-1130" y="-935">x = 0</label>
		</transition>
		<transition>
			<source ref="id38"/>
			<target ref="id34"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id38"/>
		</transition>
		<transition>
			<source ref="id39"/>
			<target ref="id35"/>
			<nail x="-1241" y="-450"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id39"/>
		</transition>
		<transition>
			<source ref="id37"/>
			<target ref="id33"/>
			<label kind="synchronisation" x="-1462" y="-960">disconnected[id]!</label>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id37"/>
			<label kind="guard" x="-1785" y="-790">y &gt; max_lat + disconnect_timeout</label>
		</transition>
		<transition>
			<source ref="id36"/>
			<target ref="id35"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id36"/>
			<label kind="guard" x="-1521" y="-739">y &gt; max_lat &amp;&amp;
y &lt;= max_lat + disconnect_timeout</label>
			<nail x="-1708" y="-680"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id34"/>
			<label kind="guard" x="-1377" y="-569">y &lt;= max_lat</label>
		</transition>
		<transition>
			<source ref="id34"/>
			<target ref="id35"/>
			<label kind="assignment" x="-1215" y="-518">y = 0</label>
			<nail x="-1224" y="-484"/>
		</transition>
		<transition>
			<source ref="id33"/>
			<target ref="id40"/>
			<label kind="synchronisation" x="-1266" y="-960">stream[id]?</label>
			<label kind="assignment" x="-1266" y="-935">x = 0,
y = 0</label>
		</transition>
	</template>
	<template>
		<name>UserSample</name>
		<parameter>int id, int audio_quality, int bit_depth, int codec_latency, int dma_latency</parameter>
		<declaration>// id: UE identification number
// audio_quality: audio sampling rate (kHz or kbps)
// bit_depth: bits per sample

clock x;

// Assumption: codecs used are sample-based (not frame-based)

// if audio quality in sample rate (kHz)
//int sample_rate = audio_quality/unit;    // samples per (ms * unit)
//int time_per_sample = (int)ceil(1/sample_rate);    // one sample in (ms * unit) - ROUNDED to a higher value

// if audio quality in bit rate (kbps)
int time_per_sample = (audio_quality/bit_depth)/unit;    // samples per (ms * unit);


</declaration>
		<location id="id44" x="-662" y="-654">
			<name x="-688" y="-705">SAMPLE</name>
			<label kind="invariant" x="-705" y="-688">x &lt;= time_per_sample</label>
		</location>
		<location id="id45" x="-416" y="-654">
			<name x="-484" y="-705">PROCESS_CODEC</name>
			<label kind="invariant" x="-476" y="-688">x &lt;= codec_latency</label>
		</location>
		<location id="id46" x="-892" y="-654">
			<name x="-918" y="-688">INITIAL</name>
		</location>
		<location id="id47" x="-416" y="-569">
			<name x="-399" y="-578">LOAD_TO_MEM</name>
			<label kind="invariant" x="-399" y="-561">x &lt;= dma_latency</label>
		</location>
		<location id="id48" x="-892" y="-569">
			<name x="-986" y="-578">STOPPING</name>
			<urgent/>
		</location>
		<init ref="id46"/>
		<transition>
			<source ref="id44"/>
			<target ref="id48"/>
			<label kind="synchronisation" x="-850" y="-518">disconnected[id]?</label>
			<nail x="-697" y="-518"/>
			<nail x="-892" y="-518"/>
		</transition>
		<transition>
			<source ref="id44"/>
			<target ref="id48"/>
			<label kind="synchronisation" x="-850" y="-569">stop_sample[id]?</label>
			<nail x="-697" y="-569"/>
		</transition>
		<transition>
			<source ref="id47"/>
			<target ref="id44"/>
			<label kind="guard" x="-629" y="-552">x &gt; dma_latency</label>
			<label kind="synchronisation" x="-629" y="-569">sample_ready[id]!</label>
			<label kind="assignment" x="-629" y="-535">samples_ready[id] += 1,
x = 0</label>
			<nail x="-637" y="-569"/>
		</transition>
		<transition>
			<source ref="id45"/>
			<target ref="id47"/>
			<label kind="guard" x="-408" y="-637">x &gt; codec_latency</label>
			<label kind="assignment" x="-408" y="-620">x = 0</label>
		</transition>
		<transition>
			<source ref="id48"/>
			<target ref="id46"/>
			<label kind="assignment" x="-935" y="-629">x = 0,
x' = 0</label>
		</transition>
		<transition>
			<source ref="id46"/>
			<target ref="id44"/>
			<label kind="synchronisation" x="-824" y="-680">sample[id]?</label>
			<label kind="assignment" x="-824" y="-654">x = 0,
x' = 1</label>
		</transition>
		<transition>
			<source ref="id44"/>
			<target ref="id45"/>
			<label kind="guard" x="-620" y="-654">x &gt; time_per_sample</label>
			<label kind="assignment" x="-620" y="-637">x = 0</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
usr_1 = User(23, 192, 1, 50);
// List one or more processes to be composed into a system.
system usr_1;
    </system>
	<queries>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
	</queries>
</nta>
